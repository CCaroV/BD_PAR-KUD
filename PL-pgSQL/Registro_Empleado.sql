-- Procedimiento para crear un operador en la BD.
-- CREATE OR REPLACE PROCEDURE PARQUEADERO.CREAR_OPERADOR_PR(
--     IN TIPO_IDENTIFICACION_P PARQUEADERO.EMPLEADO.TIPO_IDENTIFICACION_EMPLEADO%TYPE,
--     IN NUMERO_IDENTIFICACION_P PARQUEADERO.EMPLEADO.NUMERO_IDENTIFICACION_EMP%TYPE,
--     IN NOMBRE1_EMPLEADO_P PARQUEADERO.EMPLEADO.NOMBRE1_EMPLEADO%TYPE,
--     IN NOMBRE2_EMPLEADO_P PARQUEADERO.EMPLEADO.NOMBRE2_EMPLEADO%TYPE,
--     IN APELLIDO1_EMPLEADO_P PARQUEADERO.EMPLEADO.APELLIDO1_EMPLEADO%TYPE,
--     IN APELLIDO2_CLIENTE_P PARQUEADERO.EMPLEADO.APELLIDO2_EMPLEADO%TYPE,
--     IN TELEFONO_EMPLEADO_P PARQUEADERO.EMPLEADO.TELEFONO_EMPLEADO%TYPE,
--     IN CORREO_EMPLEADO_P VARCHAR
-- )
-- LANGUAGE PLPGSQL
-- AS $$
-- DECLARE
--     -- Declaraci贸n de variables locales
--     CORREO_ENCRIPTADO_L BYTEA := PARQUEADERO.PGP_SYM_ENCRYPT(CORREO_EMPLEADO_P::VARCHAR, 'AES_KEY'::VARCHAR);
--     CLAVE_ALEATORIA_L TEXT;
--     K_EMPLEADO_L PARQUEADERO.EMPLEADO.K_EMPLEADO%TYPE;
-- BEGIN
--     -- Genera una clave aleatoria.
--     SELECT PARQUEADERO.CLAVE_ALEATORIA_FU(8) INTO CLAVE_ALEATORIA_L;

--     -- Crea el usuario en la BD con la clave aleatoria
--     EXECUTE FORMAT('CREATE ROLE %I WITH LOGIN PASSWORD %L IN ROLE OPERADOR_ROLE', CORREO_EMPLEADO_P, CLAVE_ALEATORIA_L);

--     -- Inserta los datos del operador en la BD
--     INSERT INTO PARQUEADERO.EMPLEADO(
--         TIPO_IDENTIFICACION_EMPLEADO,
--         NUMERO_IDENTIFICACION_EMP,
--         NOMBRE1_EMPLEADO,
--         NOMBRE2_EMPLEADO,
--         APELLIDO1_EMPLEADO,
--         APELLIDO2_EMPLEADO,
--         TELEFONO_EMPLEADO,
--         CORREO_EMPLEADO
--     )
--     VALUES (
--         TIPO_IDENTIFICACION_P,
--         NUMERO_IDENTIFICACION_P,
--         NOMBRE1_EMPLEADO_P,
--         NOMBRE2_EMPLEADO_P,
--         APELLIDO1_EMPLEADO_P,
--         APELLIDO2_CLIENTE_P,
--         TELEFONO_EMPLEADO_P,
--         CORREO_ENCRIPTADO_L
--     )
--     RETURNING K_EMPLEADO INTO K_EMPLEADO_L;

--     -- Inserta el cargo del operador en la tabla ejerce de la BD
--     INSERT INTO PARQUEADERO.EJERCE(
--         K_EMPLEADO,
--         K_NOMBRE_CARGO,
--         FECHA_INICIO_CARGO,
--         FECHA_FIN_CARGO,
--         ES_CARGO_ACTIVO
--     )
--     VALUES (
--         K_EMPLEADO_L,
--         'Operador',
--         CURRENT_TIMESTAMP AT TIME ZONE 'America/Bogota',
--         NULL,
--         TRUE
--     );

--     -- Retorna la clave del operador
--     RETURN CLAVE_ALEATORIA_L;
-- EXCEPTION
--     -- Excepciones
--     WHEN OTHERS THEN
--         ROLLBACK;
--         RAISE EXCEPTION 'CREAR_OPERADOR_FU ha ocurrido un error: %/%', SQLSTATE, SQLERRM;
-- END;
-- $$;

-- COMMENT ON FUNCTION PARQUEADERO.CREAR_OPERADOR_FU IS E'Funci贸n que crea un operador en la base de datos.';

-- ALTER FUNCTION PARQUEADERO.CREAR_OPERADOR_FU(
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     NUMERIC,
--     CHARACTER VARYING
-- ) OWNER TO PARKUD_DB_ADMIN;

-- -- Procedimiento para crear un administrador en la BD.
-- CREATE OR REPLACE FUNCTION PARQUEADERO.CREAR_ADMIN_FU(
--     IN TIPO_IDENTIFICACION_P PARQUEADERO.EMPLEADO.TIPO_IDENTIFICACION_EMPLEADO%TYPE,
--     IN NUMERO_IDENTIFICACION_P PARQUEADERO.EMPLEADO.NUMERO_IDENTIFICACION_EMP%TYPE,
--     IN NOMBRE1_EMPLEADO_P PARQUEADERO.EMPLEADO.NOMBRE1_EMPLEADO%TYPE,
--     IN NOMBRE2_EMPLEADO_P PARQUEADERO.EMPLEADO.NOMBRE2_EMPLEADO%TYPE,
--     IN APELLIDO1_EMPLEADO_P PARQUEADERO.EMPLEADO.APELLIDO1_EMPLEADO%TYPE,
--     IN APELLIDO2_CLIENTE_P PARQUEADERO.EMPLEADO.APELLIDO2_EMPLEADO%TYPE,
--     IN TELEFONO_EMPLEADO_P PARQUEADERO.EMPLEADO.TELEFONO_EMPLEADO%TYPE,
--     IN CORREO_EMPLEADO_P VARCHAR
-- )
-- RETURNS TEXT
-- LANGUAGE PLPGSQL
-- AS $$
-- DECLARE
--     -- Declaraci贸n de variables locales
--     CORREO_ENCRIPTADO_L BYTEA := PARQUEADERO.PGP_SYM_ENCRYPT(CORREO_EMPLEADO_P::VARCHAR, 'AES_KEY'::VARCHAR);
--     CLAVE_ALEATORIA_L TEXT;
--     K_EMPLEADO_L PARQUEADERO.EMPLEADO.K_EMPLEADO%TYPE;
-- BEGIN
--     -- Genera una clave aleatoria.
--     SELECT PARQUEADERO.CLAVE_ALEATORIA_FU(8) INTO CLAVE_ALEATORIA_L;

--     -- Crea el usuario en la BD con la clave aleatoria
--     EXECUTE FORMAT('CREATE ROLE %I WITH LOGIN PASSWORD %L IN ROLE ADMIN_ROLE', CORREO_EMPLEADO_P, CLAVE_ALEATORIA_L);

--     -- Inserta los datos del operador en la BD
--     INSERT INTO PARQUEADERO.EMPLEADO(
--         TIPO_IDENTIFICACION_EMPLEADO,
--         NUMERO_IDENTIFICACION_EMP,
--         NOMBRE1_EMPLEADO,
--         NOMBRE2_EMPLEADO,
--         APELLIDO1_EMPLEADO,
--         APELLIDO2_EMPLEADO,
--         TELEFONO_EMPLEADO,
--         CORREO_EMPLEADO
--     )
--     VALUES (
--         TIPO_IDENTIFICACION_P,
--         NUMERO_IDENTIFICACION_P,
--         NOMBRE1_EMPLEADO_P,
--         NOMBRE2_EMPLEADO_P,
--         APELLIDO1_EMPLEADO_P,
--         APELLIDO2_CLIENTE_P,
--         TELEFONO_EMPLEADO_P,
--         CORREO_ENCRIPTADO_L
--     )
--     RETURNING K_EMPLEADO INTO K_EMPLEADO_L;

--     -- Inserta el cargo del operador en la tabla ejerce de la BD
--     INSERT INTO PARQUEADERO.EJERCE(
--         K_EMPLEADO,
--         K_NOMBRE_CARGO,
--         FECHA_INICIO_CARGO,
--         FECHA_FIN_CARGO,
--         ES_CARGO_ACTIVO
--     )
--     VALUES (
--         K_EMPLEADO_L,
--         'Administrador',
--         CURRENT_TIMESTAMP AT TIME ZONE 'America/Bogota',
--         NULL,
--         TRUE
--     );
    
--     -- Retorna la clave del operador
--     RETURN CLAVE_ALEATORIA_L;
-- EXCEPTION
--     -- Excepciones
--     WHEN OTHERS THEN
--         ROLLBACK;
--         RAISE EXCEPTION 'CREAR_ADMIN_FU ha ocurrido un error: %/%', SQLSTATE, SQLERRM;
-- END;
-- $$;

-- COMMENT ON FUNCTION PARQUEADERO.CREAR_ADMIN_FU IS E'Funci贸n que crea un operador en la base de datos.';

-- ALTER FUNCTION PARQUEADERO.CREAR_ADMIN_FU(
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     CHARACTER VARYING,
--     NUMERIC,
--     CHARACTER VARYING
-- ) OWNER TO PARKUD_DB_ADMIN;

-- REVOKE EXECUTE ON FUNCTION PARQUEADERO.CREAR_ADMIN_FU FROM ADMIN_ROLE;
